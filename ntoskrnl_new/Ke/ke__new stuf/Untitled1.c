kd> dl 0xfffff800`008a2000 1000 5
fffff800`008a2000  fffff800`0079bea0 fffff800`0009a010 00000000`00000006 00000000`00000000 00000000`00000001 LoaderFirmwarePermanent
fffff800`0079bea0  fffff800`0079bec8 fffff800`008a2000 00000000`0000001a 00000000`00000001 00000000`00000001 LoaderHALCachedMemory
fffff800`0079bec8  fffff800`0079bef0 fffff800`0079bea0 00000000`0000001a 00000000`00000002 00000000`00000001 LoaderHALCachedMemory
fffff800`0079bef0  fffff800`0079bf18 fffff800`0079bec8 00000000`0000001a 00000000`00000003 00000000`00000001 LoaderHALCachedMemory
fffff800`0079bf18  fffff800`008a2028 fffff800`0079bef0 00000000`0000001a 00000000`00000004 00000000`00000001 LoaderHALCachedMemory
fffff800`008a2028  fffff800`008a2050 fffff800`0079bf18 00000000`00000005 00000000`00000005 00000000`0000000a LoaderFirmwareTemporary
fffff800`008a2050  fffff800`008a2078 fffff800`008a2028 00000000`00000004 00000000`0000000f 00000000`00000071 LoaderLoadedProgram
fffff800`008a2078  fffff800`008a20a0 fffff800`008a2050 00000000`00000005 00000000`00000080 00000000`00000011 LoaderFirmwareTemporary
fffff800`008a20a0  fffff800`008a20c8 fffff800`008a2078 00000000`00000008 00000000`00000091 00000000`00000007
fffff800`008a20c8  fffff800`008a20f0 fffff800`008a20a0 00000000`00000005 00000000`00000098 00000000`00000002 LoaderFirmwareTemporary
fffff800`008a20f0  fffff800`008a2118 fffff800`008a20c8 00000000`00000001 00000000`0000009a 00000000`00000001
fffff800`008a2118  fffff800`008a2140 fffff800`008a20f0 00000000`00000011 00000000`0000009b 00000000`00000002
fffff800`008a2140  fffff800`008a2168 fffff800`008a2118 00000000`00000014 00000000`0000009d 00000000`00000002
fffff800`008a2168  fffff800`008a2190 fffff800`008a2140 00000000`00000006 00000000`0000009f 00000000`00000051 LoaderFirmwarePermanent
fffff800`008a2190  fffff800`008a21b8 fffff800`008a2168 00000000`00000016 00000000`000000f0 00000000`00000010
fffff800`008a21b8  fffff800`008a21e0 fffff800`008a2190 00000000`00000007 00000000`00000100 00000000`00000400
fffff800`008a21e0  fffff800`008a2208 fffff800`008a21b8 00000000`00000015 00000000`00000500 00000000`00000024
fffff800`008a2208  fffff800`008a2230 fffff800`008a21e0 00000000`00000009 00000000`00000524 00000000`00000261
fffff800`008a2230  fffff800`008a2258 fffff800`008a2208 00000000`0000000a 00000000`00000785 00000000`0000001a
fffff800`008a2258  fffff800`008a2280 fffff800`008a2230 00000000`00000009 00000000`0000079f 00000000`00000005
fffff800`008a2280  fffff800`008a22a8 fffff800`008a2258 00000000`0000000b 00000000`000007a4 00000000`000000f5
fffff800`008a22a8  fffff800`008a22d0 fffff800`008a2280 00000000`00000014 00000000`00000899 00000000`00000019
fffff800`008a22d0  fffff800`008a22f8 fffff800`008a22a8 00000000`00000002 00000000`000008b2 00000000`0000074d
fffff800`008a22f8  fffff800`008a2320 fffff800`008a22d0 00000000`00000016 00000000`00000fff 00000000`00000001
fffff800`008a2320  fffff800`0009a010 fffff800`008a22f8 00000000`00000002 00000000`000013dd 00000000`00006c12
fffff800`0009a010  fffff800`008a2000 fffff800`008a2320 fffff800`004eb01c fffff800`004ea108 fffff800`00746220


80087008  80087148 80087268 80092a90 80092d70 8055e890
80087148  80095388 80087008 00000006 00000000 00000001 LoaderFirmwarePermanent
80095388  80095600 80087148 0000000b 00000001 00000009 LoaderBootDriver
80095600  80087160 80095388 0000000b 0000000a 00000003 LoaderBootDriver
80087160  8008d708 80095600 00000013 0000000d 00000003 LoaderRegistryData
8008d708  800956c8 80087160 00000009 00000010 00000008 LoaderSystemCode
800956c8  8071c940 8008d708 0000000b 00000018 00000005 LoaderBootDriver
8071c940  8008d720 800956c8 0000001a 0000001d 00000001 LoaderHALCachedMemory
8008d720  8071c954 8071c940 00000002 0000001e 00000002 LoaderFree
8071c954  80087178 8008d720 0000001a 00000020 00000010 LoaderHALCachedMemory
80087178  80087190 8071c954 00000005 00000030 00000009 LoaderFirmwareTemporary
80087190  800871a8 80087178 00000014 00000039 0000000c
800871a8  800871c0 80087190 00000005 00000045 0000001b LoaderFirmwareTemporary
800871c0  80093df8 800871a8 00000005 00000060 00000002 LoaderFirmwareTemporary
80093df8  800870d0 800871c0 00000015 00000062 00000024
800870d0  80087298 80093df8 00000002 00000086 00000001 LoaderFree
80087298  80087280 800870d0 00000007 00000087 00000010
80087280  800870b8 80087298 00000008 00000097 00000008
800870b8  80087130 80087280 00000006 0000009f 00000001 LoaderFirmwarePermanent
80087130  80087118 800870b8 00000006 000000a0 00000050 LoaderFirmwarePermanent
80087118  8008d7f0 80087130 00000016 000000f0 00000010
8008d7f0  800952d0 80087118 00000013 00000100 00000240 LoaderRegistryData
800952d0  80095480 8008d7f0 0000000b 00000340 00000031 LoaderBootDriver
80095480  80095538 800952d0 0000000b 00000371 00000015 LoaderBootDriver
80095538  800957c0 80095480 0000000b 00000386 0000000f LoaderBootDriver
800957c0  80095888 80095538 0000000b 00000395 00000007 LoaderBootDriver
80095888  80095988 800957c0 0000000b 0000039c 0000000d LoaderBootDriver
80095988  80095a38 80095888 0000000b 000003a9 0000000f LoaderBootDriver
80095a38  80095b00 80095988 0000000b 000003b8 00000025 LoaderBootDriver
80095b00  80095d48 80095a38 0000000b 000003dd 00000007 LoaderBootDriver
80095d48  80096090 80095b00 0000000b 000003e4 0000000e LoaderBootDriver
80096090  800870e8 80095d48 0000000b 000003f2 0000000c LoaderBootDriver
800870e8  80087220 80096090 00000002 000003fe 00000002 LoaderFree
80087220  800871f0 800870e8 00000005 00000400 00000001 LoaderFirmwareTemporary
800871f0  80087208 80087220 00000004 00000401 0000007d LoaderLoadedProgram
80087208  8008a430 800871f0 00000005 0000047e 00000060 LoaderFirmwareTemporary
8008a430  8008a478 80087208 00000009 000004de 00000235 LoaderSystemCode
8008a478  8008a4c0 8008a430 0000000a 00000713 0000001a
8008a4c0  80095bc8 8008a478 00000009 0000072d 00000008 LoaderSystemCode
80095bc8  80095c80 8008a4c0 0000000b 00000735 0000002a LoaderBootDriver
80095c80  80095e10 80095bc8 0000000b 0000075f 00000022 LoaderBootDriver
80095e10  80095ed8 80095c80 0000000b 00000781 0000001c LoaderBootDriver
80095ed8  80095f90 80095e10 0000000b 0000079d 0000000f LoaderBootDriver
80095f90  80096148 80095ed8 0000000b 000007ac 00000016 LoaderBootDriver
80096148  80096448 80095f90 0000000b 000007c2 0000002d LoaderBootDriver
80096448  800871d8 80096148 0000000b 000007ef 00000009 LoaderBootDriver
800871d8  80088f08 80096448 00000002 000007f8 00000008 LoaderFree
80088f08  80088f38 800871d8 00000007 00000800 00000201
80088f38  80096210 80088f08 00000007 00000a01 00000001
80096210  800962d8 80088f38 0000000b 00000a02 00000021 LoaderBootDriver
800962d8  80096390 80096210 0000000b 00000a23 00000041 LoaderBootDriver
80096390  80088f20 800962d8 0000000b 00000a64 00000022 LoaderBootDriver
80088f20  80087238 80096390 00000002 00000a86 0000053a LoaderFree
80087238  80087100 80088f20 00000005 00000fc0 00000040
80087100  80087250 80087238 00000002 00001000 0000eff0 LoaderFree
80087250  80087268 80087100 00000016 0000fff0 00000010
80087268  80087008 80087250 00000016 000fffc0 00000040


    lea rax, NtAllocateLocallyUniqueId[rip]
    mov r10, StackBytes
    jmp KiZwSystemService

/**
 * \brief KiZwSystemService
 * \param rax Address of Nt* function
 * \param r10 Number of parameter stack bytes
 *
 * Stack layout:
 *      rsp + ?? | Parameters to Zw function
 *      rsp + ?? | Return address of Zw function
 *      rsp + ?? | KTRAP_FRAME
 *      rsp + 00 | Parameters to Nt function
 */
.PROC KiZwSystemService

    /* Allocate a trap frame on the stack */
    sub esp, SIZE_KTRAP_FRAME

    /* Save rcx, rsi and rdi in the new trap frame */
    mov [rsp + KTRAP_FRAME_Rcx], rcx
    mov [rsp + KTRAP_FRAME_Rsi], rsi
    mov [rsp + KTRAP_FRAME_Rdi], rdi

    .ENDPROLOG

    /* Save the SEH chain and terminate it */
    mov r11, gs:[KPCR_ExceptionList]
    mov [rsp + KTRAP_FRAME_ExceptionList], r11
    mov qword ptr gs:[KPCR_ExceptionList], EXCEPTION_CHAIN_END

    /* Load the address of original parameters into rsi */
    lea rsi, [rsp + SIZE_KTRAP_FRAME + 8]

    /* Get current thread */ */
    mov r11, gs:[KPCR_CurrentThread]

    /* Save the old trap frame in TrapFrame.Rdx */
    mov rdi, [r11 + KTHREAD_TrapFrame]
    mov [rsp + KTRAP_FRAME_Rdx], rdi

    /* Set the new trap frame and previous mode */
    mov [r11 + KTHREAD_TrapFrame], rsp
    mov byte ptr [r11 + KTHREAD_PreviousMode], 0

    /* Allocate space for new parameters */
    sub esp, r10

    /* Copy the parameters */
    lea rdi, [rsp]
    mov rcx, r10
    shr rcx, 3
    rep movsq

    /* Restore rcx */
    mov rcx, [rsp + r10 + KTRAP_FRAME_Rcx]

    /* We need the number of stack bytes later, save it in rsi */
    mov rsi, r10

    /* Call the Nt function */
    call rax


    mov r10, rsi

    /* Restore SEH chain */
    mov r11, [rsp + KTRAP_FRAME_ExceptionList]
    mov gs:[KPCR_ExceptionList], r11

    /* Restore the old trap frame */
    mov r11, gs:[KPCR_CurrentThread]
    mov rsi, [rsp + KTRAP_FRAME_Rdx]
    mov [r11 + KTHREAD_TrapFrame], rsi

    /* restore rsi and rdi */
    mov rsi, [rsp + KTRAP_FRAME_Rsi]
    mov rdi, [rsp + KTRAP_FRAME_Rdi]

    /* Get the return address from the stack */
    mov r11, [rsp + SIZE_KTRAP_FRAME]

    /* Cleanup the stack */
    lea rsp, [rsp + r10 + SIZE_KTRAP_FRAME + 8]

    /* resume execution */
    jmp r11
.ENDP

///////////////////////////////////////

ZwBla:
    /* Save first 4 parameters */
    mov [rsp + P1Home], rcx
    mov [rsp + P2Home], rdx
    mov [rsp + P3Home], r8
    mov [rsp + P4Home], r9

    lea rcx, NtBla
    mov rdx, Stackbytes

    /* Call the C function */
    sub rsp, 0x40
    call KiZwSystemServiceHandler
    add rsp, 0x40

    ret


KiZwSystemService:
    /* Save first 4 parameters */
    mov [rsp + P1Home], rcx
    mov [rsp + P2Home], rdx
    mov [rsp + P3Home], r8
    mov [rsp + P4Home], r9

    /* Space for params */
    sub rsp, 0x40

    call KiZwSystemServiceHandler
    ret


VOID
DECLSPEC_NORETURN
KiZwSystemServiceHandler(
    IN ULONG64 P1,
    IN ULONG64 P2,
    IN ULONG64 P3,
    IN ULONG64 P3)
{
    ULONG64 StackFrame;
    PKTRAP_FRAME TrapFrame;

    StackFrame = (ULONG64)_AddressOfReturnAddress();
    TrapFrame = (PKTRAP_FRAME)(StackFrame + 8)



    KiSystemCallTrampoline(P1, P2, P3, P4, )

}


KiSystemCallTrampoline:
    /* Load the new stack */
    mov rax, [rsp + P4Home + 8], rcx

    call rax


KiZwSystemService:

    sub rsp, KTRAP_FRAME_LENGTH + 8
    sub rsp, r10

    call r11


ZwBla:
    sub rsp, KTRAP_FRAME_LENGTH + Stackbytes

    mov [rsp + Stackbytes + KTRAP_FRAME_Rax], offset NtBla
    mov [rsp + Stackbytes + KTRAP_FRAME_Rbx], Stackbytes

    /* Call the C function */
    call KiZwSystemServiceHandler

    /* Cleanup and return */
    add rsp, KTRAP_FRAME_LENGTH
    ret



ZwBla -> KiZwSystemServiceHandler -> KiSystemcallTrampoline -> NtBla

ZwBla jmp KiZwSystemService
-> KiZwSysteServiceProlog
-> NtBla
-> KiZwSystemserviceEpilog


    /* Clear DR7 and check for debugging */
    TrapFrame->Dr7 = 0;
    if (Thread->Header.DebugActive & 0xFF)
    {
        UNIMPLEMENTED;
        while (TRUE);
    }

    /* Increase system call count */
    KeGetCurrentPrcb()->KeSystemCalls++;

    /* FIXME: Increase individual counts on debug systems */
    //KiIncreaseSystemCallCount(DescriptorTable, Id);

    /* Restore the old trap frame */
    Thread->TrapFrame = (PKTRAP_FRAME)TrapFrame->Edx;

    /* Exit from system call */
    KiServiceExit(TrapFrame, Result);    jmp rax



KiSwapThread (C)
KiSwapContext (asm)
KiSwapContextInternal (asm)
KiSwapContextEntry (C)
KiSwitchThreads (asm)
KiSwapContextExit (C)

KiSwapContext
    // push all non-volatile

    KiSwapContextInternal
        sub esp, 2 * 4
        mov ecx, esp
        jmp @KiSwapContextEntry@8

    KiSwapContextEntry
        // SwitchFrame->ApcBypass = ApcBypass;
        // Pcr->ContextSwitches++;
        // OldThread->KernelStack = SwitchFrame;
        // NewThread = Pcr->PrcbData.CurrentThread;

        KiSwitchThreads(OldThread, NewThread->KernelStack);
            mov esp, edx
            call @KiSwapContextExit@8
                NewThread = Pcr->PrcbData.CurrentThread;
                OldProcess = OldThread->ApcState.Process;
                NewProcess = NewThread->ApcState.Process;
                if (OldProcess != NewProcess)
                {
                    __writecr3(NewProcess->DirectoryTableBase[0]);
                }
                // Set the TEB
                // Set new TSS fields
                NewThread->ContextSwitches++;


            add esp, 2 * 4
            ret

    // pop non-volatiles
    // return




KiSwapContext
    push rbp
    mov rbp, rsp
    push ApcBypass
    sub rsp, 5 * 8
    .endprolog

    mov rcx, rsp
    call KiSwapContextSuspend

    mov esp,

    call KiSwapContextResume

    mov rsp, rbp
    pop rbp
    ret

KiSwapContextInternal
    mov


